name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            artifact_name: knots-linux-x64
            knots_binary: target/release/knots
            test_complexity_binary: target/release/test-complexity
          - os: windows-2022
            artifact_name: knots-windows-x64
            knots_binary: target/release/knots.exe
            test_complexity_binary: target/release/test-complexity.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' knots/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
        shell: bash

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Rust installation
        run: |
          rustc --version
          cargo --version

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Security Audit - Check Dependencies
        run: |
          cargo install cargo-audit
          cargo audit
        continue-on-error: true

      - name: Build Release Binary
        run: cargo build --release --workspace

      - name: Run Tests - Knots
        run: cargo test --release -p knots
        continue-on-error: true

      - name: Run Tests - Test Complexity
        run: cargo test --release -p test-complexity
        continue-on-error: true

      - name: Verify Binaries
        run: |
          echo "=== Verifying binaries ==="
          ${{ matrix.knots_binary }} --version
          ${{ matrix.test_complexity_binary }} --help | head -5

      - name: List Build Output (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "=== Build Artifacts ==="
          echo "Knots binary:"
          ls -lh ${{ matrix.knots_binary }} || echo "Knots binary not found"
          echo "Test-complexity binary:"
          ls -lh ${{ matrix.test_complexity_binary }} || echo "Test-complexity binary not found"

      - name: List Build Output (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Host "=== Build Artifacts ==="
          Write-Host "Knots binary:"
          if (Test-Path "${{ matrix.knots_binary }}") {
            Get-Item "${{ matrix.knots_binary }}" | Format-List Name, Length, LastWriteTime
          } else {
            Write-Host "Knots binary not found"
          }
          Write-Host "Test-complexity binary:"
          if (Test-Path "${{ matrix.test_complexity_binary }}") {
            Get-Item "${{ matrix.test_complexity_binary }}" | Format-List Name, Length, LastWriteTime
          } else {
            Write-Host "Test-complexity binary not found"
          }
        shell: pwsh

      - name: Stage Artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARTIFACT_DIR="artifacts/${{ matrix.artifact_name }}-${VERSION}"
          mkdir -p "${ARTIFACT_DIR}"
          cp ${{ matrix.knots_binary }} "${ARTIFACT_DIR}/"
          cp ${{ matrix.test_complexity_binary }} "${ARTIFACT_DIR}/"
          cp README.md "${ARTIFACT_DIR}/" 2>/dev/null || true
          cp test-complexity/README.md "${ARTIFACT_DIR}/TEST_COMPLEXITY_README.md" 2>/dev/null || true
          cp hooks/README.md "${ARTIFACT_DIR}/HOOKS_README.md" 2>/dev/null || true
          echo "=== Artifacts staged ==="
          ls -lh "${ARTIFACT_DIR}/"
          echo "ARTIFACT_DIR=${ARTIFACT_DIR}" >> $GITHUB_ENV

      - name: Stage Artifacts (Windows)
        if: runner.os == 'Windows'
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          $ARTIFACT_DIR = "artifacts/${{ matrix.artifact_name }}-${VERSION}"
          New-Item -ItemType Directory -Force -Path $ARTIFACT_DIR
          Copy-Item "${{ matrix.knots_binary }}" -Destination $ARTIFACT_DIR
          Copy-Item "${{ matrix.test_complexity_binary }}" -Destination $ARTIFACT_DIR
          Copy-Item "README.md" -Destination $ARTIFACT_DIR -ErrorAction SilentlyContinue
          Copy-Item "test-complexity/README.md" -Destination "$ARTIFACT_DIR/TEST_COMPLEXITY_README.md" -ErrorAction SilentlyContinue
          Copy-Item "hooks/README.md" -Destination "$ARTIFACT_DIR/HOOKS_README.md" -ErrorAction SilentlyContinue
          Write-Host "=== Artifacts staged ==="
          Get-ChildItem $ARTIFACT_DIR
          echo "ARTIFACT_DIR=${ARTIFACT_DIR}" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.version.outputs.VERSION }}
          path: ${{ env.ARTIFACT_DIR }}
          retention-days: 30

  package:
    name: Package Release
    needs: build
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' knots/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: knots-linux-x64-${{ steps.version.outputs.VERSION }}
          path: artifacts/knots-linux-x64-${{ steps.version.outputs.VERSION }}

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: knots-windows-x64-${{ steps.version.outputs.VERSION }}
          path: artifacts/knots-windows-x64-${{ steps.version.outputs.VERSION }}

      - name: Verify Release Package
        run: |
          echo "=== Downloaded Artifacts ==="
          ls -lR artifacts/
          echo ""
          echo "Release package ready with version: ${{ steps.version.outputs.VERSION }}"

      - name: Create Release Archive (Linux)
        run: |
          cd artifacts
          tar -czf knots-linux-x64-${{ steps.version.outputs.VERSION }}.tar.gz knots-linux-x64-${{ steps.version.outputs.VERSION }}
          cd ..

      - name: Create Release Archive (Windows)
        run: |
          cd artifacts
          zip -r knots-windows-x64-${{ steps.version.outputs.VERSION }}.zip knots-windows-x64-${{ steps.version.outputs.VERSION }}
          cd ..

      - name: Upload Release Archives
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ steps.version.outputs.VERSION }}
          path: |
            artifacts/*.tar.gz
            artifacts/*.zip
          retention-days: 90
